version: "3.8"

services:
  migrate:
    image: brunobh51/flowlog:v10
    command: >
      sh -c "python manage.py migrate --noinput && python manage.py collectstatic --noinput && python manage.py shell -c \"from django.contrib.auth import get_user_model; import os; User=get_user_model(); e=os.getenv('DJANGO_SUPERUSER_EMAIL'); p=os.getenv('DJANGO_SUPERUSER_PASSWORD'); (e and p and not User.objects.filter(email=e).exists()) and User.objects.create_superuser(email=e, password=p) or print('superuser ok')\""
    environment:
      TZ: America/Sao_Paulo
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: ${DEBUG}
      USE_SQLITE: ${USE_SQLITE}
      SITE_URL: ${SITE_URL}
      DB_HOST: ${DB_HOST}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_PORT: ${DB_PORT}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND}
      EVOLUTION_API_URL: ${EVOLUTION_API_URL}
      EVOLUTION_API_KEY: ${EVOLUTION_API_KEY}
      DJANGO_SUPERUSER_EMAIL: ${DJANGO_SUPERUSER_EMAIL}
      DJANGO_SUPERUSER_PASSWORD: ${DJANGO_SUPERUSER_PASSWORD}
    volumes:
      - static_volume:/app/staticfiles
    networks:
      - app_network
    deploy:
      replicas: 1
      restart_policy:
        condition: none
      resources:
        limits:
          cpus: "0.5"
          memory: 512M

  flowlog:
    image: brunobh51/flowlog:v10
    command: >
      gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 2 --timeout 60 --access-logfile - --error-logfile -
    environment:
      TZ: America/Sao_Paulo
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: ${DEBUG}
      USE_SQLITE: ${USE_SQLITE}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS}
      CSRF_TRUSTED_ORIGINS: ${CSRF_TRUSTED_ORIGINS}
      SITE_URL: ${SITE_URL}
      DJANGO_ADMIN_PATH: ${DJANGO_ADMIN_PATH}
      DB_HOST: ${DB_HOST}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_PORT: ${DB_PORT}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND}
      EVOLUTION_API_URL: ${EVOLUTION_API_URL}
      EVOLUTION_API_KEY: ${EVOLUTION_API_KEY}
    volumes:
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    networks:
      - traefik_public
      - app_network
    # CORREÇÃO: Healthcheck movido para o nível do serviço (fora de deploy)
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/healthcheck/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      replicas: 1
      # CORREÇÃO: Policy on-failure para garantir restart se crashar
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.docker.network=traefik_public
        - traefik.http.routers.flowlog.rule=Host(`flowlog.lojabibelo.com.br`)
        - traefik.http.routers.flowlog.entrypoints=websecure
        - traefik.http.routers.flowlog.tls.certresolver=le
        - traefik.http.services.flowlog.loadbalancer.server.port=8000
      resources:
        limits:
          cpus: "1.0"
          memory: 768M

  worker:
    image: brunobh51/flowlog:v10
    # CORREÇÃO: Removido ignore-result do comentário e garantido filas corretas
    command: celery -A config worker -l info -Q default,whatsapp --concurrency=2
    environment:
      TZ: America/Sao_Paulo
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: ${DEBUG}
      USE_SQLITE: ${USE_SQLITE}
      SITE_URL: ${SITE_URL}
      DB_HOST: ${DB_HOST}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_PORT: ${DB_PORT}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND}
      EVOLUTION_API_URL: ${EVOLUTION_API_URL}
      EVOLUTION_API_KEY: ${EVOLUTION_API_KEY}
      # CORREÇÃO: C_FORCE_ROOT para evitar problemas de permissão se rodar como root (embora Dockerfile use django-user)
      C_FORCE_ROOT: "true"
    networks:
      - app_network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 10s
      resources:
        limits:
          cpus: "1"
          memory: 1024M

  beat:
    image: brunobh51/flowlog:v10
    command: celery -A config beat -l info --schedule=/tmp/celerybeat-schedule
    environment:
      TZ: America/Sao_Paulo
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: ${DEBUG}
      USE_SQLITE: ${USE_SQLITE}
      SITE_URL: ${SITE_URL}
      DB_HOST: ${DB_HOST}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_PORT: ${DB_PORT}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND}
    networks:
      - app_network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 10s
      resources:
        limits:
          cpus: "0.5"
          memory: 512M

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --appendfsync everysec --maxmemory 256mb --maxmemory-policy allkeys-lru
    environment:
      TZ: America/Sao_Paulo
    volumes:
      - redis_data:/data
    networks:
      - app_network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      resources:
        limits:
          cpus: "0.5"
          memory: 512M

volumes:
  static_volume:
  media_volume:
  redis_data:
  celerybeat_data:


networks:
  traefik_public:
    external: true
  app_network:
    external: true
