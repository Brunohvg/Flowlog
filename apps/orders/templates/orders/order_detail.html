{% extends "base/base.html" %}
{% load flowlog_tags %}

{% block title %}{{ order.code }} - Detalhes{% endblock %}
{% block page_title %}Pedido {{ order.code }}{% endblock %}
{% block page_subtitle %}Criado em {{ order.created_at|date:"d/m/Y às H:i" }}{% endblock %}

{% block content %}

<div class="mb-6 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
  <a href="{% url 'order_list' %}" class="btn btn-secondary btn-sm group">
    <i data-lucide="arrow-left" class="w-4 h-4 group-hover:-translate-x-1 transition-transform"></i> Voltar
  </a>

  <div class="flex flex-wrap gap-2">
    {% if order.is_priority %}
      <span class="badge bg-red-100 text-red-700 border border-red-200">
        <i data-lucide="alert-circle" class="w-3 h-3"></i> Prioritário
      </span>
    {% endif %}

    <a href="{% url 'order_label' order.id %}" target="_blank" class="btn btn-secondary btn-sm" title="Imprimir Etiqueta">
      <i data-lucide="printer" class="w-4 h-4"></i>
    </a>
    <a href="{% url 'order_duplicate' order.id %}" class="btn btn-secondary btn-sm" title="Duplicar">
      <i data-lucide="copy" class="w-4 h-4"></i>
    </a>
    {% if order.is_active %}
    <a href="{% url 'order_edit' order.id %}" class="btn btn-secondary btn-sm">
      <i data-lucide="edit" class="w-4 h-4"></i> Editar
    </a>
    {% endif %}
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

  <div class="lg:col-span-2 space-y-6">

    <div class="card p-6 border-l-4
      {% if order.order_status == 'cancelled' or order.order_status == 'returned' %}border-red-500
      {% elif order.payment_status == 'paid' %}border-emerald-500
      {% else %}border-amber-500{% endif %}">

      <div class="flex flex-col sm:flex-row justify-between gap-4 mb-6">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 rounded-2xl flex items-center justify-center
            {% if order.order_status == 'cancelled' %}bg-red-100 text-red-600
            {% elif order.payment_status == 'paid' %}bg-emerald-100 text-emerald-600
            {% else %}bg-indigo-100 text-indigo-600{% endif %}">
            <i data-lucide="shopping-bag" class="w-7 h-7"></i>
          </div>
          <div>
            <h3 class="text-xl font-bold text-slate-800">{{ order.code }}</h3>
            <p class="text-sm text-slate-500">{{ order.customer.name }}</p>
          </div>
        </div>

        <div class="text-right">
          <p class="text-3xl font-bold text-slate-800">R$ {{ order.total_value|currency }}</p>
          <div class="flex justify-end gap-2 mt-1">
            {% if order.payment_status == 'paid' %}
              <span class="badge bg-emerald-100 text-emerald-700 text-xs px-2 py-0.5"><i data-lucide="check" class="w-3 h-3 mr-1"></i> Pago</span>
            {% elif order.payment_status == 'refunded' %}
              <span class="badge bg-red-100 text-red-700 text-xs px-2 py-0.5">Reembolsado</span>
            {% else %}
              <span class="badge bg-amber-100 text-amber-700 text-xs px-2 py-0.5"><i data-lucide="clock" class="w-3 h-3 mr-1"></i> Aguardando Pagamento</span>
            {% endif %}
          </div>
        </div>
      </div>

      {% if order.order_status != 'cancelled' and order.order_status != 'returned' %}
      <div class="relative py-2">
        <div class="absolute top-1/2 left-0 w-full h-1 bg-slate-100 -translate-y-1/2 rounded"></div>
        <div class="absolute top-1/2 left-0 h-1 bg-emerald-500 -translate-y-1/2 rounded transition-all duration-500"
             style="width: {% if order.delivery_status == 'delivered' or order.delivery_status == 'picked_up' %}100%{% elif order.delivery_status == 'shipped' or order.delivery_status == 'ready_for_pickup' %}66%{% else %}33%{% endif %}"></div>

        <div class="relative flex justify-between text-xs font-medium text-slate-500">
          <div class="text-center bg-white px-2">
            <div class="w-8 h-8 mx-auto rounded-full flex items-center justify-center mb-1 bg-emerald-500 text-white shadow-sm border-2 border-white">
              <i data-lucide="check" class="w-4 h-4"></i>
            </div>
            Confirmado
          </div>

          <div class="text-center bg-white px-2">
            <div class="w-8 h-8 mx-auto rounded-full flex items-center justify-center mb-1 border-2 border-white shadow-sm
              {% if order.delivery_status != 'pending' %}bg-emerald-500 text-white{% else %}bg-slate-200 text-slate-400{% endif %}">
              <i data-lucide="{% if order.delivery_type == 'pickup' %}package{% else %}truck{% endif %}" class="w-4 h-4"></i>
            </div>
            {% if order.delivery_type == 'pickup' %}Pronto{% else %}Enviado{% endif %}
          </div>

          <div class="text-center bg-white px-2">
            <div class="w-8 h-8 mx-auto rounded-full flex items-center justify-center mb-1 border-2 border-white shadow-sm
              {% if order.delivery_status in 'delivered,picked_up' %}bg-emerald-500 text-white{% else %}bg-slate-200 text-slate-400{% endif %}">
              <i data-lucide="check-circle" class="w-4 h-4"></i>
            </div>
            {% if order.delivery_type == 'pickup' %}Retirado{% else %}Entregue{% endif %}
          </div>
        </div>
      </div>
      {% else %}
        <div class="bg-red-50 p-3 rounded-lg text-center text-red-700 font-medium">
            Pedido {{ order.get_order_status_display }}
        </div>
      {% endif %}
    </div>

    <div class="card p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-slate-800 flex items-center gap-2">
            <i data-lucide="user" class="w-5 h-5 text-blue-500"></i> Cliente
        </h3>
        <div class="flex gap-2">
            <a href="https://wa.me/55{{ order.customer.phone_normalized }}" target="_blank" class="btn btn-success btn-sm px-3">
              <i data-lucide="message-circle" class="w-4 h-4"></i> WhatsApp
            </a>
            <a href="{% url 'customer_detail' order.customer.id %}" class="btn btn-secondary btn-sm px-3">Ver Perfil</a>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
        <div>
            <span class="text-slate-400 block text-xs uppercase font-bold">Nome</span>
            <span class="text-slate-800 font-medium">{{ order.customer.name }}</span>
        </div>
        <div>
            <span class="text-slate-400 block text-xs uppercase font-bold">Telefone</span>
            <span class="text-slate-800">{{ order.customer.phone }}</span>
        </div>
        {% if order.customer.cpf %}
        <div>
            <span class="text-slate-400 block text-xs uppercase font-bold">CPF</span>
            <span class="text-slate-800">{{ order.customer.cpf }}</span>
        </div>
        {% endif %}
        {% if order.customer.email %}
        <div>
            <span class="text-slate-400 block text-xs uppercase font-bold">Email</span>
            <span class="text-slate-800">{{ order.customer.email }}</span>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="card p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-slate-800 flex items-center gap-2">
            {% if order.delivery_type == 'pickup' %}
                <i data-lucide="store" class="w-5 h-5 text-amber-500"></i> Retirada
            {% else %}
                <i data-lucide="truck" class="w-5 h-5 text-blue-500"></i> Entrega
            {% endif %}
        </h3>
        {% if order.can_change_delivery_type %}
        <a href="{% url 'order_change_delivery' order.id %}" class="text-xs text-indigo-600 hover:underline flex items-center gap-1">
            <i data-lucide="repeat" class="w-3 h-3"></i> Alterar tipo
        </a>
        {% endif %}
      </div>

      <div class="bg-slate-50 rounded-xl p-4 border border-slate-100">
          {% if order.delivery_type == 'pickup' %}
            <div class="text-center py-2">
                <span class="block text-slate-500 text-sm mb-1">Cliente irá retirar na loja</span>
                {% if order.delivery_status == 'ready_for_pickup' %}
                    <span class="badge bg-purple-100 text-purple-700">Aguardando Retirada</span>
                    <div class="mt-2 text-xs text-slate-400">Expira em: {{ order.expires_at|date:"d/m H:i" }}</div>
                {% endif %}
            </div>
          {% else %}
            {% if order.delivery_address %}
                <p class="text-slate-800 text-sm whitespace-pre-line mb-3">{{ order.delivery_address }}</p>
            {% else %}
                <p class="text-slate-400 text-sm italic">Sem endereço cadastrado.</p>
            {% endif %}

            {% if order.tracking_code %}
            <div class="flex items-center justify-between bg-white p-2 rounded-lg border border-slate-200">
                <div class="flex items-center gap-2">
                    <i data-lucide="package" class="w-4 h-4 text-indigo-500"></i>
                    <span class="font-mono font-bold text-slate-700">{{ order.tracking_code }}</span>
                </div>
                {% if order.tracking_url %}
                <a href="{{ order.tracking_url }}" target="_blank" class="text-xs btn btn-secondary btn-sm py-1 px-2 h-auto">Rastrear</a>
                {% endif %}
            </div>
            {% endif %}
          {% endif %}
      </div>
    </div>

    <div class="space-y-4">
        {% if order.notes %}
        <div class="card p-4 bg-yellow-50 border border-yellow-100">
            <h4 class="text-xs font-bold text-yellow-700 uppercase mb-1 flex items-center gap-1">
                <i data-lucide="sticky-note" class="w-3 h-3"></i> Observação do Pedido
            </h4>
            <p class="text-sm text-yellow-900">{{ order.notes }}</p>
        </div>
        {% endif %}

        {% if order.internal_notes %}
        <div class="card p-4 bg-slate-50 border border-slate-200 border-dashed">
            <h4 class="text-xs font-bold text-slate-500 uppercase mb-1 flex items-center gap-1">
                <i data-lucide="lock" class="w-3 h-3"></i> Nota Interna
            </h4>
            <p class="text-sm text-slate-700">{{ order.internal_notes }}</p>
        </div>
        {% endif %}

        {% if activities %}
        <div class="card p-6">
            <h3 class="font-bold text-slate-800 mb-4">Histórico</h3>
            <div class="space-y-4 relative before:absolute before:left-2 before:top-2 before:bottom-2 before:w-0.5 before:bg-slate-100">
                {% for activity in activities %}
                <div class="relative pl-8">
                    <div class="absolute left-0 top-1 w-4 h-4 rounded-full border-2 border-white shadow-sm bg-slate-200 z-10 flex items-center justify-center">
                        <div class="w-1.5 h-1.5 rounded-full bg-slate-500"></div>
                    </div>
                    <p class="text-sm text-slate-700">{{ activity.description }}</p>
                    <p class="text-xs text-slate-400 mt-0.5">
                        {{ activity.created_at|date:"d/m H:i" }}
                        {% if activity.user %} • {{ activity.user.get_full_name|default:activity.user.email }}{% endif %}
                    </p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

  </div>

  <div class="space-y-6">

    <div class="card p-5 border border-indigo-100 shadow-sm">
        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
            <i data-lucide="zap" class="w-5 h-5 text-amber-500"></i> Próxima Etapa
        </h3>

        <div class="space-y-3">
            {# --- CENÁRIO 1: JÁ ENTREGUE / FINALIZADO --- #}
            {% if order.delivery_status == 'delivered' or order.delivery_status == 'picked_up' %}

                {% if order.payment_status == 'pending' %}
                    <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                        <p class="text-xs font-bold text-red-700 uppercase mb-2">⚠️ Finalizar: Receber Pagamento</p>
                        <p class="text-xs text-red-600 mb-3">O pedido foi entregue, mas consta como pendente.</p>
                        <a href="{% url 'order_mark_paid' order.id %}" class="w-full btn bg-red-600 hover:bg-red-700 text-white border-none justify-center mb-2">
                            <i data-lucide="wallet" class="w-4 h-4"></i> Confirmar Recebimento
                        </a>
                        <button onclick="openPaymentLinkModal()" class="w-full btn bg-white text-red-700 border-red-200 hover:bg-red-50 justify-center">
                            <i data-lucide="link" class="w-4 h-4"></i> Gerar Link
                        </button>
                    </div>
                {% else %}
                    <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100 text-center">
                        <div class="w-10 h-10 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i data-lucide="check-circle" class="w-6 h-6"></i>
                        </div>
                        <p class="text-sm font-bold text-emerald-800">Pedido Concluído!</p>
                        <p class="text-xs text-emerald-600">Entrega e pagamento finalizados.</p>
                    </div>
                {% endif %}

            {# --- CENÁRIO 2: FLUXO EM ANDAMENTO (Ainda não entregue) --- #}
            {% else %}

                {% if order.payment_status == 'pending' and order.order_status != 'cancelled' %}
                    <div class="bg-amber-50 p-4 rounded-xl border border-amber-100">
                        <p class="text-xs font-bold text-amber-700 uppercase mb-3">1. Receber Pagamento</p>
                        <a href="{% url 'order_mark_paid' order.id %}" class="w-full btn bg-amber-500 hover:bg-amber-600 text-white border-none justify-center mb-2">
                            <i data-lucide="wallet" class="w-4 h-4"></i> Confirmar Manualmente
                        </a>
                        <button onclick="openPaymentLinkModal()" class="w-full btn bg-white text-amber-700 border-amber-200 hover:bg-amber-50 justify-center">
                            <i data-lucide="link" class="w-4 h-4"></i> Gerar Link Pagar.me
                        </button>
                    </div>
                {% endif %}

                {% if order.order_status != 'cancelled' and order.order_status != 'returned' %}

                    {% if order.can_be_shipped %}
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                            <p class="text-xs font-bold text-blue-700 uppercase mb-3">2. Expedição</p>
                            <a href="{% url 'order_mark_shipped' order.id %}" class="w-full btn bg-blue-600 hover:bg-blue-700 text-white border-none justify-center">
                                <i data-lucide="truck" class="w-4 h-4"></i>
                                {% if order.is_correios %}Informar Rastreio{% else %}Marcar como Enviado{% endif %}
                            </a>
                        </div>
                    {% endif %}

                    {% if order.can_be_ready_for_pickup %}
                        <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                            <p class="text-xs font-bold text-purple-700 uppercase mb-3">2. Separação</p>
                            <a href="{% url 'order_ready_for_pickup' order.id %}" class="w-full btn bg-purple-600 hover:bg-purple-700 text-white border-none justify-center">
                                <i data-lucide="package-check" class="w-4 h-4"></i> Avisar Pronto
                            </a>
                        </div>
                    {% endif %}

                    {% if order.delivery_status == 'shipped' %}
                        <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                            <p class="text-xs font-bold text-emerald-700 uppercase mb-3">3. Entrega</p>
                            <a href="{% url 'order_mark_delivered' order.id %}" class="w-full btn bg-emerald-600 hover:bg-emerald-700 text-white border-none justify-center mb-2">
                                <i data-lucide="check-circle" class="w-4 h-4"></i> Confirmar Entrega
                            </a>
                            <form method="post" action="{% url 'order_mark_failed_attempt' order.id %}">
                                {% csrf_token %}
                                <button type="submit" class="w-full btn bg-white text-red-600 border-red-200 hover:bg-red-50 justify-center">
                                    <i data-lucide="alert-triangle" class="w-4 h-4"></i> Tentativa Falha
                                </button>
                            </form>
                        </div>
                    {% endif %}

                    {% if order.delivery_status == 'ready_for_pickup' %}
                        <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                            <p class="text-xs font-bold text-emerald-700 uppercase mb-3">3. Balcão</p>
                            <a href="{% url 'order_mark_picked_up' order.id %}" class="w-full btn bg-emerald-600 hover:bg-emerald-700 text-white border-none justify-center">
                                <i data-lucide="user-check" class="w-4 h-4"></i> Confirmar Retirada
                            </a>
                        </div>
                    {% endif %}

                {% endif %} {% endif %} </div>
    </div>

    <div class="card p-5 border-t-4 border-indigo-500 shadow-sm">
        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
            <i data-lucide="credit-card" class="w-5 h-5 text-indigo-500"></i> Financeiro
        </h3>

        {% with link=order.payment_links.first %}
            {% if link %}
                <div class="bg-slate-50 rounded-xl p-3 border border-slate-200 mb-3">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-xs font-bold text-slate-400 uppercase">Link Pagar.me</span>
                        <a href="{% url 'payment_link_detail' link.id %}" class="text-xs text-indigo-600 hover:underline">Ver</a>
                    </div>

                    {% if link.status == 'paid' %}
                        <div class="flex items-center gap-2 text-emerald-600 font-bold text-sm mb-2 bg-emerald-50 p-2 rounded-lg justify-center">
                            <i data-lucide="check-circle" class="w-4 h-4"></i> Pago
                        </div>
                        {% if link.payer_name %}
                        <div class="text-xs text-slate-500 text-center">
                            Por: {{ link.payer_name|truncatechars:20 }}
                        </div>
                        {% endif %}
                    {% elif link.status == 'pending' %}
                        <div class="flex items-center gap-2 text-amber-600 font-bold text-sm mb-3 justify-center">
                            <i data-lucide="clock" class="w-4 h-4"></i> Aguardando
                        </div>
                        <button onclick="copyToClipboard('{{ link.checkout_url }}', this)" class="w-full btn bg-white border border-slate-300 text-slate-600 hover:border-indigo-300 hover:text-indigo-600 text-xs justify-center shadow-sm">
                            <i data-lucide="copy" class="w-3 h-3"></i> Copiar Link
                        </button>
                    {% else %}
                        <div class="text-center">
                            <span class="badge bg-slate-200 text-slate-600">{{ link.get_status_display }}</span>
                        </div>
                    {% endif %}
                </div>
            {% else %}
                {% if order.payment_status != 'paid' and order.order_status != 'cancelled' %}
                    <div class="text-center py-2">
                        <button onclick="openPaymentLinkModal()" class="w-full btn bg-emerald-600 hover:bg-emerald-700 text-white border-none justify-center shadow-md shadow-emerald-200 transition-all mb-2">
                            <i data-lucide="link" class="w-4 h-4"></i> Gerar Link de Pagamento
                        </button>
                        <p class="text-xs text-slate-400">Integração Pagar.me</p>
                    </div>
                {% else %}
                    <div class="bg-slate-50 rounded-lg p-3 text-center text-xs text-slate-400">
                        {% if order.payment_status == 'paid' %}Pagamento Confirmado{% else %}Pedido Cancelado{% endif %}
                    </div>
                {% endif %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="card p-5">
        <h3 class="font-bold text-slate-800 mb-3 text-sm uppercase text-slate-400">Opções</h3>

        <div class="space-y-2">
            {% if order.can_be_returned %}
            <a href="{% url 'order_return' order.id %}" class="w-full flex items-center gap-2 p-2 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors text-sm">
                <i data-lucide="package-x" class="w-4 h-4"></i> Processar Devolução
            </a>
            {% endif %}

            {% if order.can_resend_notification %}
            <form method="post" action="{% url 'order_resend_notification' order.id %}">
                {% csrf_token %}
                <input type="hidden" name="type" value="created">
                <button type="submit" class="w-full flex items-center gap-2 p-2 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors text-sm text-left">
                    <i data-lucide="send" class="w-4 h-4"></i> Reenviar Notificação
                </button>
            </form>
            {% endif %}

            {% if order.can_be_cancelled %}
            <a href="{% url 'order_cancel' order.id %}" class="w-full flex items-center gap-2 p-2 rounded-lg text-red-600 hover:bg-red-50 transition-colors text-sm">
                <i data-lucide="x" class="w-4 h-4"></i> Cancelar Pedido
            </a>
            {% endif %}

            {% if order.order_status == 'pending' or order.order_status == 'cancelled' %}
                {% if order.payment_status != 'paid' %}
                <button onclick="openDeleteModal()" class="w-full flex items-center gap-2 p-2 rounded-lg text-red-600 hover:bg-red-50 transition-colors text-sm text-left">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Deletar Pedido
                </button>
                {% endif %}
            {% endif %}
        </div>
    </div>

    <div class="card p-5 bg-slate-800 text-white shadow-lg">
        <h3 class="font-bold mb-2 text-sm flex items-center gap-2">
            <i data-lucide="eye" class="w-4 h-4 text-indigo-400"></i> Link Público do Cliente
        </h3>
        <p class="text-xs text-slate-400 mb-3">Envie este link para o cliente acompanhar.</p>
        <div class="flex gap-2">
            <input type="text" value="{{ request.scheme }}://{{ request.get_host }}{% url 'tracking_detail' order.code %}" readonly class="bg-slate-700 border-none text-xs rounded px-3 py-2 flex-1 text-slate-300 focus:ring-0 focus:outline-none cursor-default" id="tracking-link">
            <button onclick="copyToClipboard(document.getElementById('tracking-link').value, this)" class="p-2 bg-indigo-600 hover:bg-indigo-500 rounded text-white transition-colors" title="Copiar Link Público">
                <i data-lucide="copy" class="w-4 h-4"></i>
            </button>
        </div>
    </div>

    <div class="text-xs text-slate-400 text-center">
        Vendedor: {{ order.seller.get_full_name|default:order.seller.email }}
    </div>

  </div>

</div>

{% endblock %}

{% block scripts %}
<div id="paymentLinkModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4 transition-opacity duration-200">
  <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-100 transition-transform">
    <div class="text-center mb-6">
      <div class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-3">
        <i data-lucide="credit-card" class="w-6 h-6 text-emerald-600"></i>
      </div>
      <h3 class="text-lg font-bold text-slate-800">Novo Link de Pagamento</h3>
      <p class="text-slate-500 text-sm mt-1">{{ order.code }} - R$ {{ order.total_value|currency }}</p>
    </div>

    <div id="paymentLinkForm">
      <div class="mb-4">
        <label class="form-label text-sm mb-2 block font-medium">Parcelamento</label>
        <select id="installments" class="form-select w-full border-slate-300 rounded-lg">
          <option value="1">1x (à vista)</option>
          <option value="2">até 2x</option>
          <option value="3">até 3x</option>
          <option value="4">até 4x</option>
          <option value="5">até 5x</option>
          <option value="6">até 6x</option>
        </select>
      </div>

      <div class="bg-slate-50 p-3 rounded-xl mb-6 text-xs text-slate-500 flex items-center gap-2">
        <i data-lucide="info" class="w-4 h-4 text-slate-400"></i> Link expira automaticamente em 12h.
      </div>

      <div class="grid grid-cols-2 gap-3">
        <button onclick="closePaymentLinkModal()" class="btn btn-secondary justify-center">Cancelar</button>
        <button onclick="generatePaymentLink()" class="btn btn-primary justify-center bg-emerald-600 hover:bg-emerald-700 border-none shadow-none">
          Gerar Link
        </button>
      </div>
    </div>

    <div id="paymentLinkLoading" class="hidden py-8 text-center">
        <div class="animate-spin w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full mx-auto mb-3"></div>
        <p class="text-sm text-slate-500">Conectando ao Pagar.me...</p>
    </div>

    <div id="paymentLinkResult" class="hidden">
        <div class="bg-emerald-50 border border-emerald-100 rounded-xl p-4 mb-4 text-center">
            <p class="text-emerald-700 font-bold text-sm mb-1">Link Criado!</p>
            <input type="text" id="generatedLink" readonly class="w-full bg-white border border-emerald-200 rounded px-2 py-1 text-xs text-center text-slate-600 focus:outline-none" />
        </div>
        <div class="grid grid-cols-2 gap-3">
            <button onclick="copyGeneratedLink(this)" class="btn btn-secondary justify-center text-sm">Copiar</button>
            <a id="openLinkBtn" href="#" target="_blank" class="btn btn-primary justify-center text-sm">Abrir</a>
        </div>
    </div>

    <div id="paymentLinkError" class="hidden">
        <div class="bg-red-50 border border-red-100 rounded-xl p-4 mb-4 text-center">
            <p class="text-red-700 font-bold text-sm mb-1">Erro ao criar</p>
            <p id="errorMessage" class="text-xs text-red-500">Falha na comunicação</p>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <button onclick="closePaymentLinkModal()" class="btn btn-secondary justify-center">Fechar</button>
            <button onclick="retryPaymentLink()" class="btn btn-primary justify-center">Tentar Novamente</button>
        </div>
    </div>

  </div>
</div>

<div id="deleteModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
  <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl text-center">
    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
      <i data-lucide="trash-2" class="w-6 h-6 text-red-600"></i>
    </div>
    <h3 class="text-lg font-bold text-slate-800 mb-2">Excluir Pedido?</h3>
    <p class="text-slate-500 text-sm mb-6">Essa ação não pode ser desfeita. O histórico será perdido.</p>
    <div class="grid grid-cols-2 gap-3">
      <button onclick="closeDeleteModal()" class="btn btn-secondary justify-center">Cancelar</button>
      <form method="post" action="{% url 'order_delete' order.id %}">
        {% csrf_token %}
        <button type="submit" class="w-full btn bg-red-600 hover:bg-red-700 text-white border-none justify-center">Excluir</button>
      </form>
    </div>
  </div>
</div>

<script>
  // Utils: Copiar sem Alert (Feedback no botão)
  function copyToClipboard(text, btnElement) {
    if(!text) return;
    navigator.clipboard.writeText(text).then(() => {
        if(btnElement) {
            const originalContent = btnElement.innerHTML;
            // Muda para icone de check
            btnElement.innerHTML = '<i data-lucide="check" class="w-4 h-4 inline"></i> Copiado!';
            btnElement.classList.add('bg-emerald-100', 'text-emerald-700', 'border-emerald-200');
            btnElement.classList.remove('bg-white', 'text-slate-600', 'border-slate-300');

            lucide.createIcons();

            // Reverte após 2s
            setTimeout(() => {
                btnElement.innerHTML = originalContent;
                btnElement.classList.remove('bg-emerald-100', 'text-emerald-700', 'border-emerald-200');
                btnElement.classList.add('bg-white', 'text-slate-600', 'border-slate-300');
                lucide.createIcons();
            }, 2000);
        }
    });
  }

  // Delete Modal
  const deleteModal = document.getElementById('deleteModal');
  function openDeleteModal() { deleteModal.classList.remove('hidden'); deleteModal.classList.add('flex'); }
  function closeDeleteModal() { deleteModal.classList.add('hidden'); deleteModal.classList.remove('flex'); }
  deleteModal.addEventListener('click', (e) => { if(e.target === deleteModal) closeDeleteModal(); });

  // Payment Modal
  const paymentModal = document.getElementById('paymentLinkModal');
  const paymentForm = document.getElementById('paymentLinkForm');
  const paymentLoading = document.getElementById('paymentLinkLoading');
  const paymentResult = document.getElementById('paymentLinkResult');
  const paymentError = document.getElementById('paymentLinkError');

  function openPaymentLinkModal() {
    paymentModal.classList.remove('hidden');
    paymentModal.classList.add('flex');
    // Reset
    paymentForm.classList.remove('hidden');
    paymentLoading.classList.add('hidden');
    paymentResult.classList.add('hidden');
    paymentError.classList.add('hidden');
  }

  function closePaymentLinkModal() {
    paymentModal.classList.add('hidden');
    paymentModal.classList.remove('flex');
    if(!paymentResult.classList.contains('hidden')) window.location.reload();
  }

  paymentModal.addEventListener('click', (e) => { if(e.target === paymentModal) closePaymentLinkModal(); });

  function retryPaymentLink() {
    paymentError.classList.add('hidden');
    paymentForm.classList.remove('hidden');
  }

  // Cópia dentro do modal
  function copyGeneratedLink(btn) {
    const input = document.getElementById('generatedLink');
    input.select();
    document.execCommand('copy');

    // Feedback visual
    const originalText = btn.innerText;
    btn.innerText = "Copiado!";
    btn.classList.add('bg-emerald-100', 'text-emerald-700');

    setTimeout(() => {
        btn.innerText = originalText;
        btn.classList.remove('bg-emerald-100', 'text-emerald-700');
    }, 1500);
  }

  async function generatePaymentLink() {
    const installments = document.getElementById('installments').value;

    paymentForm.classList.add('hidden');
    paymentLoading.classList.remove('hidden');

    try {
        const response = await fetch('/pagamentos/pedido/{{ order.id }}/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: 'installments=' + installments
        });

        const data = await response.json();
        paymentLoading.classList.add('hidden');

        if (data.success) {
            document.getElementById('generatedLink').value = data.checkout_url;
            document.getElementById('openLinkBtn').href = data.checkout_url;
            paymentResult.classList.remove('hidden');
        } else {
            document.getElementById('errorMessage').textContent = data.error || 'Erro desconhecido';
            paymentError.classList.remove('hidden');
        }
    } catch (e) {
        paymentLoading.classList.add('hidden');
        document.getElementById('errorMessage').textContent = 'Erro de conexão';
        paymentError.classList.remove('hidden');
    }
  }
</script>
{% endblock %}
