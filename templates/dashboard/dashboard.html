{% extends "base/base.html" %}
{% load flowlog_tags %}

{% block title %}Visão Geral | Flowlog{% endblock %}

{% block content %}
<div class="space-y-8">

    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-900 tracking-tight">Painel de Controlo</h1>
            <p class="text-slate-500 text-sm">Resumo da operação em {{ now|date:"l, d de F" }}</p>
        </div>
        <div class="flex gap-3">
            <a href="{% url 'order_create' %}" class="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl text-sm font-semibold shadow-sm shadow-indigo-200 transition-all hover:shadow-indigo-300 hover:-translate-y-0.5">
                <i data-lucide="plus" class="w-4 h-4"></i> Novo Pedido
            </a>
        </div>
    </div>

    <!-- FILTROS DE DATA -->
    <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
        <form method="get" class="flex flex-wrap items-end gap-4">
            <div>
                <label class="block text-xs font-medium text-slate-500 mb-1">Data Início</label>
                <input type="date" name="date_from" value="{{ date_from|date:'Y-m-d' }}"
                       class="px-3 py-2 border border-slate-200 rounded-lg text-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 outline-none">
            </div>
            <div>
                <label class="block text-xs font-medium text-slate-500 mb-1">Data Fim</label>
                <input type="date" name="date_to" value="{{ date_to|date:'Y-m-d' }}"
                       class="px-3 py-2 border border-slate-200 rounded-lg text-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 outline-none">
            </div>
            <button type="submit" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-lg transition-colors">
                <i data-lucide="filter" class="w-4 h-4 inline mr-1"></i> Filtrar
            </button>
            <a href="{% url 'dashboard' %}" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 text-sm font-medium rounded-lg transition-colors">
                Limpar
            </a>
        </form>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="group bg-white p-6 rounded-2xl border border-slate-100 shadow-[0_2px_10px_-3px_rgba(6,81,237,0.1)] hover:shadow-lg transition-all relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                <i data-lucide="wallet" class="w-16 h-16 text-indigo-600"></i>
            </div>
            <p class="text-xs font-bold text-indigo-600 uppercase tracking-wider mb-1">Receita Total</p>
            <h3 class="text-3xl font-bold text-slate-900 tracking-tight">R$ {{ stats.revenue|currency }}</h3>
            <div class="mt-4 flex items-center gap-2"><span class="text-slate-400 text-xs">Valor recebido (pago)</span></div>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:border-indigo-100 transition-colors">
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-slate-500 text-sm font-medium">Pedidos Hoje</p>
                    <h3 class="text-2xl font-bold text-slate-900 mt-1">{{ stats.orders_today }}</h3>
                </div>
                <div class="p-2 bg-blue-50 rounded-lg text-blue-600"><i data-lucide="shopping-bag" class="w-5 h-5"></i></div>
            </div>
            <p class="text-xs text-slate-400 mt-4">Volume diário</p>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:border-amber-100 transition-colors">
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-slate-500 text-sm font-medium">Pendentes</p>
                    <h3 class="text-2xl font-bold text-slate-900 mt-1">{{ stats.pending_count }}</h3>
                </div>
                <div class="p-2 bg-amber-50 rounded-lg text-amber-600"><i data-lucide="clock" class="w-5 h-5"></i></div>
            </div>
            {% if stats.pending_count > 0 %}
            <a href="{% url 'order_list' %}?status=pending" class="mt-4 inline-flex items-center text-xs font-semibold text-amber-600 hover:text-amber-700">
                Resolver agora <i data-lucide="arrow-right" class="w-3 h-3 ml-1"></i>
            </a>
            {% else %}
            <p class="mt-4 text-xs text-emerald-600 font-medium flex items-center gap-1"><i data-lucide="check-circle-2" class="w-3 h-3"></i> Tudo em dia!</p>
            {% endif %}
        </div>

        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:border-emerald-100 transition-colors">
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-slate-500 text-sm font-medium">Em Trânsito</p>
                    <h3 class="text-2xl font-bold text-slate-900 mt-1">{{ stats.shipped_count }}</h3>
                </div>
                <div class="p-2 bg-emerald-50 rounded-lg text-emerald-600"><i data-lucide="truck" class="w-5 h-5"></i></div>
            </div>
            <p class="text-xs text-slate-400 mt-4">A caminho do cliente</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <div class="lg:col-span-2 space-y-6">

            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="bar-chart-horizontal" class="w-5 h-5 text-slate-400"></i> Pipeline de Pedidos
                    </h3>
                </div>

                <div class="space-y-5">
                    {% for key, stage in stats.pipeline.items %}
                    <div class="group">
                        <div class="flex items-center justify-between text-sm mb-2">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-slate-50 flex items-center justify-center text-slate-500 group-hover:bg-indigo-50 group-hover:text-indigo-600 transition-colors">
                                    <i data-lucide="{{ stage.icon }}" class="w-4 h-4"></i>
                                </div>
                                <span class="font-medium text-slate-700">{{ stage.label }}</span>
                            </div>
                            <span class="font-bold text-slate-900 bg-slate-100 px-2 py-0.5 rounded text-xs">{{ stage.count }}</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                            <div class="h-2.5 rounded-full transition-all duration-1000 relative overflow-hidden
                                {% if key == 'pending' %}bg-amber-400 group-hover:bg-amber-500
                                {% elif key == 'processing' %}bg-blue-500 group-hover:bg-blue-600
                                {% elif key == 'shipped' %}bg-indigo-500 group-hover:bg-indigo-600
                                {% else %}bg-emerald-500 group-hover:bg-emerald-600{% endif %}"
                                style="width: {{ stage.pct }}%">
                                <div class="absolute top-0 left-0 bottom-0 right-0 bg-white/20 w-full h-full -translate-x-full group-hover:animate-[shimmer_1.5s_infinite]"></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="px-6 py-5 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                    <h3 class="font-bold text-slate-800">Transações Recentes</h3>
                    <a href="{% url 'order_list' %}" class="text-xs font-semibold text-indigo-600 hover:text-indigo-800 uppercase tracking-wide">Ver tudo</a>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-white text-slate-400 font-semibold border-b border-slate-100">
                            <tr>
                                <th class="px-6 py-4">ID</th>
                                <th class="px-6 py-4">Cliente</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4 text-right">Valor</th>
                                <th class="px-6 py-4"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            {% for order in recent_orders %}
                            <tr class="hover:bg-slate-50 transition-colors group cursor-pointer" onclick="window.location='{% url 'order_detail' order.id %}'">
                                <td class="px-6 py-4"><span class="font-mono text-slate-600 font-medium group-hover:text-indigo-600 transition-colors">#{{ order.code }}</span></td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center text-xs font-bold uppercase">{{ order.customer.name|slice:":1" }}</div>
                                        <div><p class="font-medium text-slate-800">{{ order.customer.name|truncatechars:15 }}</p><p class="text-xs text-slate-400">{{ order.created_at|timesince }}</p></div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    {% if order.order_status == 'cancelled' %}<span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-red-50 text-red-700 ring-1 ring-inset ring-red-600/10">Cancelado</span>
                                    {% elif order.order_status == 'returned' %}<span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-orange-50 text-orange-700 ring-1 ring-inset ring-orange-600/10">Devolvido</span>
                                    {% elif order.delivery_status == 'delivered' or order.delivery_status == 'picked_up' %}<span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-emerald-50 text-emerald-700 ring-1 ring-inset ring-emerald-600/10">Concluído</span>
                                    {% elif order.delivery_status == 'shipped' %}<span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-indigo-50 text-indigo-700 ring-1 ring-inset ring-indigo-600/10">Enviado</span>
                                    {% elif order.delivery_status == 'ready_for_pickup' %}<span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-purple-50 text-purple-700 ring-1 ring-inset ring-purple-600/10">Pronto Retirada</span>
                                    {% else %}<span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-amber-50 text-amber-700 ring-1 ring-inset ring-amber-600/10">Pendente</span>{% endif %}
                                </td>
                                <td class="px-6 py-4 text-right font-bold text-slate-700">R$ {{ order.total_value|currency }}</td>
                                <td class="px-6 py-4 text-right"><i data-lucide="chevron-right" class="w-4 h-4 text-slate-300 group-hover:text-slate-500"></i></td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5" class="px-6 py-10 text-center text-slate-400">Sem atividade recente.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="space-y-6">

            {% if alerts %}
            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5 relative overflow-hidden">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2 relative z-10">
                    <span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-amber-500"></span></span>
                    Atenção
                </h3>
                <div class="space-y-3 relative z-10">
                    {% for alert in alerts %}
                    <a href="{% if '/pagamentos' in alert.link or 'http' in alert.link %}{{ alert.link }}{% else %}{% url 'order_list' %}{{ alert.link }}{% endif %}"
                       class="block p-3 rounded-xl transition-colors border
                              {% if alert.level == 'critical' %}bg-red-50 hover:bg-red-100 border-red-100
                              {% elif alert.level == 'warning' %}bg-amber-50 hover:bg-amber-100 border-amber-100
                              {% elif alert.level == 'info' %}bg-blue-50 hover:bg-blue-100 border-blue-100
                              {% else %}bg-slate-50 hover:bg-slate-100 border-slate-100{% endif %}">
                        <div class="flex items-start gap-3">
                            <i data-lucide="{{ alert.icon }}" class="w-5 h-5 mt-0.5
                               {% if alert.level == 'critical' %}text-red-600
                               {% elif alert.level == 'warning' %}text-amber-600
                               {% elif alert.level == 'info' %}text-blue-600
                               {% else %}text-slate-600{% endif %}"></i>
                            <div>
                                <p class="text-sm font-bold
                                   {% if alert.level == 'critical' %}text-red-800
                                   {% elif alert.level == 'warning' %}text-amber-800
                                   {% elif alert.level == 'info' %}text-blue-800
                                   {% else %}text-slate-800{% endif %}">{{ alert.title }}</p>
                                <p class="text-xs mt-0.5
                                   {% if alert.level == 'critical' %}text-red-600
                                   {% elif alert.level == 'warning' %}text-amber-600
                                   {% elif alert.level == 'info' %}text-blue-600
                                   {% else %}text-slate-600{% endif %}">{{ alert.msg }}</p>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="bg-indigo-900 rounded-2xl p-6 text-white shadow-xl shadow-indigo-100">
                <h3 class="font-bold text-lg mb-1">Central de Comando</h3>
                <p class="text-indigo-300 text-xs mb-6">Atalhos operacionais</p>
                <div class="grid grid-cols-2 gap-3">
                    <a href="{% url 'order_create' %}" class="flex flex-col items-center justify-center p-4 bg-white/10 rounded-xl hover:bg-white/20 transition-colors group cursor-pointer border border-white/5"><i data-lucide="plus-circle" class="w-6 h-6 mb-2 text-indigo-300 group-hover:text-white"></i><span class="text-xs font-medium">Vender</span></a>
                    <a href="{% url 'customer_list' %}" class="flex flex-col items-center justify-center p-4 bg-white/10 rounded-xl hover:bg-white/20 transition-colors group cursor-pointer border border-white/5"><i data-lucide="users" class="w-6 h-6 mb-2 text-slate-300 group-hover:text-white"></i><span class="text-xs font-medium">Clientes</span></a>
                    <a href="{% url 'reports' %}" class="flex flex-col items-center justify-center p-4 bg-white/10 rounded-xl hover:bg-white/20 transition-colors group cursor-pointer border border-white/5"><i data-lucide="bar-chart-2" class="w-6 h-6 mb-2 text-slate-300 group-hover:text-white"></i><span class="text-xs font-medium">Métricas</span></a>
                    <a href="{% url 'settings' %}" class="flex flex-col items-center justify-center p-4 bg-white/10 rounded-xl hover:bg-white/20 transition-colors group cursor-pointer border border-white/5"><i data-lucide="settings" class="w-6 h-6 mb-2 text-slate-300 group-hover:text-white"></i><span class="text-xs font-medium">Ajustes</span></a>
                </div>
            </div>

            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i data-lucide="truck" class="w-4 h-4 text-indigo-500"></i> Tipos de Entrega
                </h3>
                <div class="space-y-4">
                    {% for d in stats.delivery_distribution %}
                    <div>
                        <div class="flex items-center justify-between text-sm mb-1.5">
                            <div class="flex items-center gap-2">
                                <i data-lucide="{{ d.icon }}" class="w-4 h-4 text-slate-400"></i>
                                <span class="text-slate-600 font-medium">{{ d.label }}</span>
                            </div>
                            <span class="font-bold text-slate-900">{{ d.count }}</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-1.5">
                            <div class="bg-indigo-500 h-1.5 rounded-full" style="width: {{ d.pct }}%"></div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-xs text-slate-400 text-center py-2">Sem dados de entrega.</p>
                    {% endfor %}
                </div>
            </div>

            <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i data-lucide="crown" class="w-4 h-4 text-amber-500"></i> Clientes VIP
                </h3>

                <div class="space-y-4">
                    {% for customer in top_customers %}
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-full bg-gradient-to-br from-amber-100 to-amber-200 text-amber-700 flex items-center justify-center text-xs font-bold border border-amber-200">
                                {{ customer.name|slice:":1" }}
                            </div>
                            <div>
                                <p class="text-sm font-medium text-slate-800">{{ customer.name|truncatechars:15 }}</p>
                                <p class="text-[10px] text-slate-400">Total acumulado</p>
                            </div>
                        </div>
                        <span class="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-md">
                            R$ {{ customer.total_spent|currency }}
                        </span>
                    </div>
                    {% empty %}
                    <p class="text-xs text-slate-400 text-center py-4">Sem dados de clientes ainda.</p>
                    {% endfor %}
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}
