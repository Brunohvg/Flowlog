{% extends "base/base.html" %}

{% block title %}Configura√ß√µes - Flowlog{% endblock %}
{% block page_title %}Configura√ß√µes{% endblock %}
{% block page_subtitle %}Personalize o sistema{% endblock %}

{% block content %}

<div class="max-w-4xl mx-auto space-y-6">

  <!-- Tabs -->
  <div class="border-b border-slate-200">
    <nav class="flex gap-4" id="settings-tabs">
      <button type="button" data-tab="store" class="tab-btn active pb-3 px-1 text-sm font-medium border-b-2 border-indigo-500 text-indigo-600">
        <i data-lucide="store" class="w-4 h-4 inline-block mr-1"></i> Loja
      </button>
      <button type="button" data-tab="integrations" class="tab-btn pb-3 px-1 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700">
        <i data-lucide="plug" class="w-4 h-4 inline-block mr-1"></i> Integra√ß√µes
      </button>
      <button type="button" data-tab="whatsapp" class="tab-btn pb-3 px-1 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700">
        <i data-lucide="smartphone" class="w-4 h-4 inline-block mr-1"></i> WhatsApp
      </button>
      <button type="button" data-tab="messages" class="tab-btn pb-3 px-1 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700">
        <i data-lucide="message-square" class="w-4 h-4 inline-block mr-1"></i> Mensagens
      </button>
    </nav>
  </div>

  <!-- Tab: Loja -->
  <div id="tab-store" class="tab-content">
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="save_store">

      <div class="card p-6">
        <div class="flex items-center gap-3 mb-5">
          <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">
            <i data-lucide="building-2" class="w-5 h-5 text-indigo-600"></i>
          </div>
          <div>
            <h3 class="font-bold text-slate-800">Dados da Loja</h3>
            <p class="text-sm text-slate-500">Informa√ß√µes usadas nas mensagens</p>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="form-label">Nome da Loja</label>
            <input type="text" name="store_name" value="{{ tenant.name }}" class="form-input">
          </div>
          <div>
            <label class="form-label">E-mail de Contato</label>
            <input type="email" name="contact_email" value="{{ tenant.contact_email }}" class="form-input">
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="form-label">Telefone</label>
            <input type="text" name="contact_phone" value="{{ tenant.contact_phone }}" placeholder="(11) 99999-9999" class="form-input">
          </div>
          <div>
            <label class="form-label">Slug</label>
            <input type="text" value="{{ tenant.slug }}" disabled class="form-input bg-slate-50 text-slate-500">
          </div>
        </div>

        <div>
          <label class="form-label">Endere√ßo para Retirada</label>
          <textarea name="address" rows="2" class="form-textarea" placeholder="Rua, n√∫mero, bairro, cidade...">{{ tenant.address }}</textarea>
          <p class="text-xs text-slate-500 mt-1">Usado na mensagem de "Pronto para Retirada"</p>
        </div>

        <div class="flex justify-end mt-6">
          <button type="submit" class="btn btn-primary">
            <i data-lucide="check" class="w-4 h-4"></i> Salvar
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Tab: Integra√ß√µes -->
  <div id="tab-integrations" class="tab-content hidden">
    
    <!-- Header -->
    <div class="mb-6">
      <h3 class="text-lg font-bold text-slate-800">Integra√ß√µes</h3>
      <p class="text-sm text-slate-500">Conecte servi√ßos externos ao Flowlog</p>
    </div>

    <!-- Grid de Integra√ß√µes -->
    <div class="grid md:grid-cols-2 gap-4 mb-6">
      
      <!-- Card: Pagar.me -->
      <div class="card p-5 border-2 {% if tenant_settings.pagarme_enabled and tenant_settings.pagarme_api_key %}border-emerald-200 bg-emerald-50/50{% else %}border-slate-200{% endif %} hover:shadow-md transition-all cursor-pointer" onclick="document.getElementById('pagarme-config').classList.toggle('hidden')">
        <div class="flex items-start justify-between">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center">
              <i data-lucide="credit-card" class="w-6 h-6 text-emerald-600"></i>
            </div>
            <div>
              <h4 class="font-semibold text-slate-800">Pagar.me</h4>
              <p class="text-sm text-slate-500">Links de pagamento</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            {% if tenant_settings.pagarme_enabled and tenant_settings.pagarme_api_key %}
            <span class="px-2 py-1 bg-emerald-100 text-emerald-700 text-xs font-medium rounded-full">Ativo</span>
            {% else %}
            <span class="px-2 py-1 bg-slate-100 text-slate-500 text-xs font-medium rounded-full">Desativado</span>
            {% endif %}
            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
          </div>
        </div>
      </div>

      <!-- Card: WhatsApp (link para aba) -->
      <div class="card p-5 border-2 {% if tenant_settings.whatsapp_enabled and tenant_settings.whatsapp_connected %}border-emerald-200 bg-emerald-50/50{% else %}border-slate-200{% endif %} hover:shadow-md transition-all cursor-pointer" onclick="document.querySelector('[data-tab=whatsapp]').click()">
        <div class="flex items-start justify-between">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
              <i data-lucide="smartphone" class="w-6 h-6 text-green-600"></i>
            </div>
            <div>
              <h4 class="font-semibold text-slate-800">WhatsApp</h4>
              <p class="text-sm text-slate-500">Notifica√ß√µes autom√°ticas</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            {% if tenant_settings.whatsapp_enabled and tenant_settings.whatsapp_connected %}
            <span class="px-2 py-1 bg-emerald-100 text-emerald-700 text-xs font-medium rounded-full">Conectado</span>
            {% else %}
            <span class="px-2 py-1 bg-slate-100 text-slate-500 text-xs font-medium rounded-full">Desconectado</span>
            {% endif %}
            <i data-lucide="external-link" class="w-4 h-4 text-slate-400"></i>
          </div>
        </div>
      </div>

      <!-- Card: Em breve -->
      <div class="card p-5 border-2 border-dashed border-slate-200 bg-slate-50/50">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center">
            <i data-lucide="plus" class="w-6 h-6 text-slate-400"></i>
          </div>
          <div>
            <h4 class="font-semibold text-slate-400">Em breve</h4>
            <p class="text-sm text-slate-400">Novas integra√ß√µes</p>
          </div>
        </div>
      </div>

    </div>

    <!-- Config Pagar.me (expand√≠vel) -->
    <div id="pagarme-config" class="hidden">
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="save_pagarme">

        <div class="card p-6 mb-6">
          <div class="flex items-center gap-3 mb-5">
            <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center">
              <i data-lucide="settings" class="w-5 h-5 text-emerald-600"></i>
            </div>
            <div>
              <h3 class="font-bold text-slate-800">Configurar Pagar.me</h3>
              <p class="text-sm text-slate-500">Cart√£o de cr√©dito e PIX</p>
            </div>
          </div>

          <!-- Toggle Ativo -->
          <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl mb-4">
            <div>
              <p class="font-medium text-slate-800">Ativar Pagar.me</p>
              <p class="text-sm text-slate-500">Habilita gera√ß√£o de links de pagamento</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" name="pagarme_enabled" value="1" class="sr-only peer" {% if tenant_settings.pagarme_enabled %}checked{% endif %}>
              <div class="w-11 h-6 bg-slate-300 peer-focus:ring-4 peer-focus:ring-emerald-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
            </label>
          </div>

          <!-- API Key -->
          <div class="mb-4">
            <label class="form-label">Secret Key</label>
            <input type="password" name="pagarme_api_key" 
                   value="{{ tenant_settings.pagarme_api_key }}" 
                   class="form-input font-mono"
                   placeholder="sk_live_xxxxxxxxxxxxxxxx">
            <p class="text-xs text-slate-500 mt-1">
              Encontre em: Pagar.me Dashboard ‚Üí Configura√ß√µes ‚Üí Chaves (aceita sk_xxx ou base64)
            </p>
          </div>

          <!-- Max Parcelas -->
          <div class="mb-4">
            <label class="form-label">M√°ximo de Parcelas</label>
            <select name="pagarme_max_installments" class="form-select">
              <option value="1" {% if tenant_settings.pagarme_max_installments == 1 %}selected{% endif %}>1x (√† vista)</option>
              <option value="2" {% if tenant_settings.pagarme_max_installments == 2 %}selected{% endif %}>at√© 2x</option>
              <option value="3" {% if tenant_settings.pagarme_max_installments == 3 or not tenant_settings.pagarme_max_installments %}selected{% endif %}>at√© 3x</option>
            </select>
          </div>

          <!-- PIX Toggle -->
          <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl mb-4">
            <div>
              <p class="font-medium text-slate-800">Habilitar PIX</p>
              <p class="text-sm text-slate-500">Requer libera√ß√£o no Pagar.me</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" name="pagarme_pix_enabled" value="1" class="sr-only peer" {% if tenant_settings.pagarme_pix_enabled %}checked{% endif %}>
              <div class="w-11 h-6 bg-slate-300 peer-focus:ring-4 peer-focus:ring-emerald-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
            </label>
          </div>

          <div class="flex justify-end mt-6">
            <button type="submit" class="btn btn-primary">
              <i data-lucide="check" class="w-4 h-4"></i> Salvar
            </button>
          </div>
        </div>

        <!-- Info -->
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
          <div class="flex items-start gap-3">
            <i data-lucide="info" class="w-5 h-5 text-blue-600 mt-0.5"></i>
            <div class="text-sm text-blue-800">
              <p class="font-medium mb-2">Como funciona:</p>
              <ul class="list-disc list-inside space-y-1 text-blue-700">
                <li>Links de pagamento expiram em <strong>12 horas</strong></li>
                <li>Checkout seguro hospedado pelo Pagar.me</li>
                <li>Status atualizado automaticamente via webhook</li>
              </ul>
              <p class="mt-3 text-xs">
                <strong>Webhook URL:</strong> 
                <code class="bg-white px-2 py-0.5 rounded">{{ request.scheme }}://{{ request.get_host }}/pagamentos/webhook/pagarme/</code>
              </p>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Tab: WhatsApp -->
  <div id="tab-whatsapp" class="tab-content hidden">
    
    <!-- Banner para p√°gina de configura√ß√£o -->
    <div class="card p-6 bg-gradient-to-r from-emerald-500 to-teal-500 text-white mb-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 bg-white/20 rounded-2xl flex items-center justify-center">
            <i data-lucide="smartphone" class="w-7 h-7"></i>
          </div>
          <div>
            <h3 class="text-xl font-bold">Conectar WhatsApp</h3>
            <p class="text-emerald-100">Configure e escaneie o QR Code em uma p√°gina dedicada</p>
          </div>
        </div>
        <a href="{% url 'whatsapp_setup' %}" class="px-6 py-3 bg-white text-emerald-600 rounded-xl font-bold hover:bg-emerald-50 transition-colors">
          <i data-lucide="qr-code" class="w-5 h-5 inline-block mr-2"></i>
          Configurar WhatsApp
        </a>
      </div>
    </div>
    
    <!-- Status da Conex√£o - CORRIGIDO -->
    <div class="card p-6 mb-6">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center">
          <i data-lucide="smartphone" class="w-5 h-5 text-emerald-600"></i>
        </div>
        <div class="flex-1">
          <h3 class="font-bold text-slate-800">Status da Conex√£o</h3>
          <p class="text-sm text-slate-500">Vis√£o geral da integra√ß√£o WhatsApp</p>
        </div>

        <!-- Status Badge - CORRIGIDO: Usa l√≥gica consistente -->
        <div>
          {% if tenant_settings.is_whatsapp_configured and tenant_settings.whatsapp_connected %}
            <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-emerald-100 text-emerald-700 rounded-full text-sm font-medium">
              <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
              Conectado
            </span>
          {% elif tenant_settings.is_whatsapp_configured %}
            <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-amber-100 text-amber-700 rounded-full text-sm font-medium">
              <span class="w-2 h-2 bg-amber-500 rounded-full"></span>
              Aguardando QR Code
            </span>
          {% else %}
            <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-slate-100 text-slate-600 rounded-full text-sm font-medium">
              <span class="w-2 h-2 bg-slate-400 rounded-full"></span>
              N√£o configurado
            </span>
          {% endif %}
        </div>
      </div>

      <!-- Info Box - CORRIGIDO: Consistente com o badge -->
      {% if tenant_settings.is_whatsapp_configured and tenant_settings.whatsapp_connected %}
      <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
        <div class="flex items-center gap-3">
          <i data-lucide="check-circle" class="w-5 h-5 text-emerald-600"></i>
          <div>
            <p class="font-medium text-emerald-800">WhatsApp conectado e funcionando</p>
            {% if tenant_settings.whatsapp_number %}
            <p class="text-sm text-emerald-600">{{ tenant_settings.whatsapp_number }}</p>
            {% endif %}
          </div>
        </div>
      </div>
      {% elif tenant_settings.is_whatsapp_configured %}
      <div class="p-4 bg-amber-50 border border-amber-200 rounded-xl">
        <div class="flex items-start gap-3">
          <i data-lucide="alert-circle" class="w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0"></i>
          <div class="text-sm text-amber-700">
            <p class="font-semibold mb-1">Inst√¢ncia criada, aguardando conex√£o</p>
            <p>Clique em "Configurar WhatsApp" para escanear o QR Code.</p>
          </div>
        </div>
      </div>
      {% else %}
      <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl">
        <div class="flex items-start gap-3">
          <i data-lucide="info" class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"></i>
          <div class="text-sm text-blue-700">
            <p class="font-semibold mb-1">WhatsApp n√£o configurado</p>
            <p>Clique no bot√£o acima para criar uma inst√¢ncia e conectar seu WhatsApp.</p>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    
    <!-- Enviar Mensagem de Teste -->
    {% if tenant_settings.is_whatsapp_configured and tenant_settings.whatsapp_connected %}
    <div class="card p-6 mb-6">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
          <i data-lucide="send" class="w-5 h-5 text-blue-600"></i>
        </div>
        <div>
          <h3 class="font-bold text-slate-800">Enviar Mensagem de Teste</h3>
          <p class="text-sm text-slate-500">Verifique se a integra√ß√£o est√° funcionando</p>
        </div>
      </div>
      
      <div class="flex gap-3">
        <input type="tel" id="test-phone" class="form-input flex-1" placeholder="11999999999">
        <button type="button" onclick="sendTestMessage()" class="btn btn-primary">
          <i data-lucide="send" class="w-4 h-4"></i> Enviar
        </button>
      </div>
      <p id="test-result" class="text-sm mt-2 hidden"></p>
    </div>
    {% endif %}

    <!-- Controle de Notifica√ß√µes -->
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="save_notifications">

      <div class="card p-6">
        <div class="flex items-center gap-3 mb-5">
          <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
            <i data-lucide="bell" class="w-5 h-5 text-purple-600"></i>
          </div>
          <div>
            <h3 class="font-bold text-slate-800">Controle de Notifica√ß√µes</h3>
            <p class="text-sm text-slate-500">Escolha quais mensagens enviar automaticamente</p>
          </div>
        </div>

        <!-- Master Switch -->
        <div class="p-4 bg-slate-50 rounded-xl mb-6">
          <label class="flex items-center justify-between cursor-pointer">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center">
                <i data-lucide="power" class="w-5 h-5 text-emerald-600"></i>
              </div>
              <div>
                <p class="font-semibold text-slate-800">Ativar WhatsApp</p>
                <p class="text-sm text-slate-500">Liga/desliga todas as notifica√ß√µes</p>
              </div>
            </div>
            <div class="relative">
              <input type="checkbox" name="whatsapp_enabled" class="sr-only peer" {% if tenant_settings.whatsapp_enabled %}checked{% endif %}>
              <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
            </div>
          </label>
        </div>

        <!-- Notifica√ß√µes por Categoria -->
        <div class="space-y-6">
          
          <!-- Pedido -->
          <div>
            <h4 class="text-sm font-semibold text-slate-600 uppercase tracking-wider mb-3 flex items-center gap-2">
              <i data-lucide="shopping-bag" class="w-4 h-4 text-indigo-500"></i> Pedido
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                <input type="checkbox" name="notify_order_created" class="w-4 h-4 text-indigo-600 rounded" {% if tenant_settings.notify_order_created %}checked{% endif %}>
                <span class="text-sm text-slate-700">Pedido Criado</span>
              </label>
              <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                <input type="checkbox" name="notify_order_confirmed" class="w-4 h-4 text-indigo-600 rounded" {% if tenant_settings.notify_order_confirmed %}checked{% endif %}>
                <span class="text-sm text-slate-700">Pedido Confirmado</span>
              </label>
            </div>
          </div>

          <!-- Pagamento -->
          <div>
            <h4 class="text-sm font-semibold text-slate-600 uppercase tracking-wider mb-3 flex items-center gap-2">
              <i data-lucide="credit-card" class="w-4 h-4 text-emerald-500"></i> Pagamento
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                <input type="checkbox" name="notify_payment_link" class="w-4 h-4 text-emerald-600 rounded" {% if tenant_settings.notify_payment_link %}checked{% endif %}>
                <span class="text-sm text-slate-700">Link de Pagamento</span>
              </label>
              <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                <input type="checkbox" name="notify_payment_received" class="w-4 h-4 text-emerald-600 rounded" {% if tenant_settings.notify_payment_received %}checked{% endif %}>
                <span class="text-sm text-slate-700">Pagamento Recebido</span>
              </label>
              <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                <input type="checkbox" name="notify_payment_refunded" class="w-4 h-4 text-emerald-600 rounded" {% if tenant_settings.notify_payment_refunded %}checked{% endif %}>
                <span class="text-sm text-slate-700">Pagamento Estornado</span>
              </label>
            </div>
          </div>

          <!-- Entrega -->
          <div>
            <h4 class="text-sm font-semibold text-slate-600 uppercase tracking-wider mb-3 flex items-center gap-2">
              <i data-lucide="truck" class="w-4 h-4 text-blue-500"></i> Entrega
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                <input type="checkbox" name="notify_order_shipped" class="w-4 h-4 text-blue-600 rounded" {% if tenant_settings.notify_order_shipped %}checked{% endif %}>
                <span class="text-sm text-slate-700">Pedido Enviado</span>
              </label>
              <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                <input type="checkbox" name="notify_order_delivered" class="w-4 h-4 text-blue-600 rounded" {% if tenant_settings.notify_order_delivered %}checked{% endif %}>
                <span class="text-sm text-slate-700">Pedido Entregue</span>
              </label>
              <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                <input type="checkbox" name="notify_delivery_failed" class="w-4 h-4 text-blue-600 rounded" {% if tenant_settings.notify_delivery_failed %}checked{% endif %}>
                <span class="text-sm text-slate-700">Tentativa de Entrega Falha</span>
              </label>
            </div>
          </div>

          <!-- Retirada -->
          <div>
            <h4 class="text-sm font-semibold text-slate-600 uppercase tracking-wider mb-3 flex items-center gap-2">
              <i data-lucide="store" class="w-4 h-4 text-purple-500"></i> Retirada
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                <input type="checkbox" name="notify_order_ready_for_pickup" class="w-4 h-4 text-purple-600 rounded" {% if tenant_settings.notify_order_ready_for_pickup %}checked{% endif %}>
                <span class="text-sm text-slate-700">Pronto para Retirada</span>
              </label>
              <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                <input type="checkbox" name="notify_order_picked_up" class="w-4 h-4 text-purple-600 rounded" {% if tenant_settings.notify_order_picked_up %}checked{% endif %}>
                <span class="text-sm text-slate-700">Pedido Retirado</span>
              </label>
              <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                <input type="checkbox" name="notify_order_expired" class="w-4 h-4 text-purple-600 rounded" {% if tenant_settings.notify_order_expired %}checked{% endif %}>
                <span class="text-sm text-slate-700">Retirada Expirada</span>
              </label>
            </div>
          </div>

          <!-- Cancelamento -->
          <div>
            <h4 class="text-sm font-semibold text-slate-600 uppercase tracking-wider mb-3 flex items-center gap-2">
              <i data-lucide="x-circle" class="w-4 h-4 text-red-500"></i> Cancelamento / Devolu√ß√£o
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                <input type="checkbox" name="notify_order_cancelled" class="w-4 h-4 text-red-600 rounded" {% if tenant_settings.notify_order_cancelled %}checked{% endif %}>
                <span class="text-sm text-slate-700">Pedido Cancelado</span>
              </label>
              <label class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100 transition-colors">
                <input type="checkbox" name="notify_order_returned" class="w-4 h-4 text-red-600 rounded" {% if tenant_settings.notify_order_returned %}checked{% endif %}>
                <span class="text-sm text-slate-700">Pedido Devolvido</span>
              </label>
            </div>
          </div>

        </div>

        <div class="flex justify-end mt-6">
          <button type="submit" class="btn btn-primary">
            <i data-lucide="check" class="w-4 h-4"></i> Salvar Notifica√ß√µes
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Tab: Mensagens -->
  <div id="tab-messages" class="tab-content hidden">
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="save_messages">

      <!-- Header -->
      <div class="card p-5 mb-6 bg-gradient-to-r from-indigo-500 to-purple-500 text-white">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
            <i data-lucide="message-square-text" class="w-6 h-6"></i>
          </div>
          <div>
            <h3 class="text-lg font-bold">Personalizar Mensagens</h3>
            <p class="text-indigo-100 text-sm">Configure o texto das notifica√ß√µes enviadas aos clientes</p>
          </div>
        </div>
      </div>

      <!-- Vari√°veis - Sticky -->
      <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6">
        <div class="flex items-start gap-3">
          <i data-lucide="lightbulb" class="w-5 h-5 text-amber-600 mt-0.5"></i>
          <div>
            <p class="text-sm font-medium text-amber-800 mb-2">Vari√°veis dispon√≠veis (copie e cole):</p>
            <div class="flex flex-wrap gap-2">
              <code class="bg-white px-2.5 py-1 rounded-lg text-xs font-mono text-amber-700 border border-amber-200 cursor-pointer hover:bg-amber-100" onclick="navigator.clipboard.writeText('{nome}')" title="Clique para copiar">{nome}</code>
              <code class="bg-white px-2.5 py-1 rounded-lg text-xs font-mono text-amber-700 border border-amber-200 cursor-pointer hover:bg-amber-100" onclick="navigator.clipboard.writeText('{codigo}')" title="Clique para copiar">{codigo}</code>
              <code class="bg-white px-2.5 py-1 rounded-lg text-xs font-mono text-amber-700 border border-amber-200 cursor-pointer hover:bg-amber-100" onclick="navigator.clipboard.writeText('{valor}')" title="Clique para copiar">{valor}</code>
              <code class="bg-white px-2.5 py-1 rounded-lg text-xs font-mono text-amber-700 border border-amber-200 cursor-pointer hover:bg-amber-100" onclick="navigator.clipboard.writeText('{loja}')" title="Clique para copiar">{loja}</code>
              <code class="bg-white px-2.5 py-1 rounded-lg text-xs font-mono text-amber-700 border border-amber-200 cursor-pointer hover:bg-amber-100" onclick="navigator.clipboard.writeText('{link_rastreio}')" title="Clique para copiar">{link_rastreio}</code>
              <code class="bg-white px-2.5 py-1 rounded-lg text-xs font-mono text-amber-700 border border-amber-200 cursor-pointer hover:bg-amber-100" onclick="navigator.clipboard.writeText('{endereco}')" title="Clique para copiar">{endereco}</code>
              <code class="bg-white px-2.5 py-1 rounded-lg text-xs font-mono text-amber-700 border border-amber-200 cursor-pointer hover:bg-amber-100" onclick="navigator.clipboard.writeText('{pickup_code}')" title="Clique para copiar">{pickup_code}</code>
              <code class="bg-white px-2.5 py-1 rounded-lg text-xs font-mono text-amber-700 border border-amber-200 cursor-pointer hover:bg-amber-100" onclick="navigator.clipboard.writeText('{link_pagamento}')" title="Clique para copiar">{link_pagamento}</code>
            </div>
            <p class="text-xs text-amber-600 mt-2">üí° Clique na vari√°vel para copiar</p>
          </div>
        </div>
      </div>

      <div class="card p-6">
        <!-- Pedido -->
        <div class="mb-8">
          <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4 pb-2 border-b">Pedido</h4>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium text-slate-700 mb-1 block">Pedido Criado</label>
              <textarea name="msg_order_created" rows="4" class="w-full text-sm border border-slate-300 rounded-lg p-3 font-mono">{{ tenant_settings.msg_order_created }}</textarea>
            </div>
            <div>
              <label class="text-sm font-medium text-slate-700 mb-1 block">Pedido Confirmado</label>
              <textarea name="msg_order_confirmed" rows="4" class="w-full text-sm border border-slate-300 rounded-lg p-3 font-mono">{{ tenant_settings.msg_order_confirmed }}</textarea>
            </div>
          </div>
        </div>

        <!-- Pagamento -->
        <div class="mb-8">
          <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4 pb-2 border-b">Pagamento</h4>
          <div class="grid md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-sm font-medium text-slate-700 mb-1 block">Link de Pagamento</label>
              <textarea name="msg_payment_link" rows="4" class="w-full text-sm border border-slate-300 rounded-lg p-3 font-mono">{{ tenant_settings.msg_payment_link }}</textarea>
              <p class="text-xs text-slate-500 mt-1">Placeholders: {nome}, {codigo}, {valor}, {link_pagamento}, {loja}</p>
            </div>
            <div>
              <label class="text-sm font-medium text-slate-700 mb-1 block">Pagamento Recebido</label>
              <textarea name="msg_payment_received" rows="4" class="w-full text-sm border border-slate-300 rounded-lg p-3 font-mono">{{ tenant_settings.msg_payment_received }}</textarea>
            </div>
          </div>
          <div>
            <label class="text-sm font-medium text-slate-700 mb-1 block">Pagamento Estornado</label>
            <textarea name="msg_payment_refunded" rows="4" class="w-full text-sm border border-slate-300 rounded-lg p-3 font-mono">{{ tenant_settings.msg_payment_refunded }}</textarea>
          </div>
        </div>

        <!-- Entrega -->
        <div class="mb-8">
          <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4 pb-2 border-b">Entrega</h4>
          <div class="grid md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-sm font-medium text-slate-700 mb-1 block">Pedido Enviado</label>
              <textarea name="msg_order_shipped" rows="4" class="w-full text-sm border border-slate-300 rounded-lg p-3 font-mono">{{ tenant_settings.msg_order_shipped }}</textarea>
            </div>
            <div>
              <label class="text-sm font-medium text-slate-700 mb-1 block">Pedido Entregue</label>
              <textarea name="msg_order_delivered" rows="4" class="w-full text-sm border border-slate-300 rounded-lg p-3 font-mono">{{ tenant_settings.msg_order_delivered }}</textarea>
            </div>
          </div>
          <div>
            <label class="text-sm font-medium text-slate-700 mb-1 block">Tentativa de Entrega Falha</label>
            <textarea name="msg_delivery_failed" rows="3" class="w-full text-sm border border-slate-300 rounded-lg p-3 font-mono">{{ tenant_settings.msg_delivery_failed }}</textarea>
          </div>
        </div>

        <!-- Retirada -->
        <div class="mb-8">
          <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4 pb-2 border-b">Retirada</h4>
          <div class="grid md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-sm font-medium text-slate-700 mb-1 block">Pronto para Retirada</label>
              <textarea name="msg_order_ready_for_pickup" rows="5" class="w-full text-sm border border-slate-300 rounded-lg p-3 font-mono">{{ tenant_settings.msg_order_ready_for_pickup }}</textarea>
            </div>
            <div>
              <label class="text-sm font-medium text-slate-700 mb-1 block">Pedido Retirado</label>
              <textarea name="msg_order_picked_up" rows="5" class="w-full text-sm border border-slate-300 rounded-lg p-3 font-mono">{{ tenant_settings.msg_order_picked_up }}</textarea>
            </div>
          </div>
          <div>
            <label class="text-sm font-medium text-slate-700 mb-1 block">Retirada Expirada</label>
            <textarea name="msg_order_expired" rows="3" class="w-full text-sm border border-slate-300 rounded-lg p-3 font-mono">{{ tenant_settings.msg_order_expired }}</textarea>
          </div>
        </div>

        <!-- Cancelamento -->
        <div class="mb-6">
          <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4 pb-2 border-b">Cancelamento / Devolu√ß√£o</h4>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium text-slate-700 mb-1 block">Pedido Cancelado</label>
              <textarea name="msg_order_cancelled" rows="4" class="w-full text-sm border border-slate-300 rounded-lg p-3 font-mono">{{ tenant_settings.msg_order_cancelled }}</textarea>
            </div>
            <div>
              <label class="text-sm font-medium text-slate-700 mb-1 block">Pedido Devolvido</label>
              <textarea name="msg_order_returned" rows="4" class="w-full text-sm border border-slate-300 rounded-lg p-3 font-mono">{{ tenant_settings.msg_order_returned }}</textarea>
            </div>
          </div>
        </div>

        <div class="flex justify-end pt-4 border-t">
          <button type="submit" class="btn btn-primary">
            <i data-lucide="check" class="w-4 h-4"></i> Salvar Mensagens
          </button>
        </div>
      </div>
    </form>
  </div>

</div>

{% endblock %}

{% block scripts %}
<script>
  // Tab switching
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.dataset.tab;

      // Remove active from all tabs
      document.querySelectorAll('.tab-btn').forEach(b => {
        b.classList.remove('active', 'border-indigo-500', 'text-indigo-600');
        b.classList.add('border-transparent', 'text-slate-500');
      });

      // Add active to clicked tab
      btn.classList.add('active', 'border-indigo-500', 'text-indigo-600');
      btn.classList.remove('border-transparent', 'text-slate-500');

      // Hide all content
      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));

      // Show selected content
      document.getElementById('tab-' + tab).classList.remove('hidden');
    });
  });
  
  // Enviar mensagem de teste
  async function sendTestMessage() {
    const phone = document.getElementById('test-phone').value.trim();
    const result = document.getElementById('test-result');
    
    if (!phone) {
      result.textContent = 'Informe o n√∫mero';
      result.className = 'text-sm mt-2 text-red-600';
      result.classList.remove('hidden');
      return;
    }
    
    result.textContent = 'Enviando...';
    result.className = 'text-sm mt-2 text-slate-600';
    result.classList.remove('hidden');
    
    try {
      const response = await fetch('{% url "whatsapp_test_message" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'phone=' + encodeURIComponent(phone)
      });
      
      const data = await response.json();
      
      if (data.success) {
        result.textContent = '‚úì Mensagem enviada!';
        result.className = 'text-sm mt-2 text-emerald-600';
      } else {
        result.textContent = '‚úó ' + (data.error || 'Erro ao enviar');
        result.className = 'text-sm mt-2 text-red-600';
      }
    } catch (e) {
      result.textContent = '‚úó Erro de conex√£o';
      result.className = 'text-sm mt-2 text-red-600';
    }
  }
</script>
{% endblock %}
